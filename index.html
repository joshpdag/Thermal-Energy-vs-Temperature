<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Volume vs Temperature Change</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 1400px;
            width: 100%;
        }
        
        .intro-screen {
            text-align: center;
            padding: 40px;
        }
        
        .intro-screen h1 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
        }
        
        .intro-screen .subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 40px;
        }
        
        .version-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }
        
        .version-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .version-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .version-card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        
        .version-card .description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            min-height: 120px;
        }
        
        .feature-list {
            text-align: left;
            margin: 20px 0;
        }
        
        .feature-list li {
            margin: 8px 0;
            color: #666;
        }
        
        .select-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .select-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .simulation-screen {
            display: none;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .simulation-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #particleCanvas {
            border: 3px solid #ddd;
            border-radius: 10px;
            background-color: #ffffff !important;
            display: block;
            margin: 0 auto;
        }
        
        .graph-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #graphCanvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            display: block;
            margin: 0 auto;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .controls.version2 {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        
        .control-section {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
        }
        
        .section-title {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
            text-align: center;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #444;
            font-size: 0.9em;
        }
        
        select, button, input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        select, input {
            background: white;
            cursor: pointer;
        }
        
        select:hover, input:hover {
            border-color: #667eea;
        }
        
        input {
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .discrete-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            font-size: 1.1em;
            padding: 15px;
        }
        
        .discrete-button:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .discrete-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #444;
        }
        
        .legend-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        
        .info-panel {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            color: #1976D2;
            margin-bottom: 8px;
        }
        
        .info-panel p {
            color: #555;
            line-height: 1.6;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        .timer-box {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            font-family: 'Courier New', monospace;
            margin-bottom: 3px;
        }
        
        .energy-value {
            font-size: 0.9em;
            color: #0066cc;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .ke-value {
            font-size: 0.9em;
            color: #28a745;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .volume-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 2px;
        }
        
        .reset-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .reset-button:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .volume-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .volume-input-group {
            text-align: center;
        }
        
        .volume-input-group label {
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        
        .volume-input-group input {
            padding: 5px;
            font-size: 0.9em;
        }
        
        .version2-only {
            display: none;
        }
        
        .version2 .version2-only {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Intro Screen -->
        <div id="introScreen" class="intro-screen">
            <h1>🌡️ Volume vs Temperature Change</h1>
            <p class="subtitle">Choose your simulation version to explore how different volumes of water cool down</p>
            
            <div class="version-selection">
                <div class="version-card" onclick="selectVersion(1)">
                    <h2>📚 Version 1: Basic Exploration</h2>
                    <div class="description">
                        Perfect for first-time exploration of the relationship between volume and cooling rate. 
                        Observe how different sized containers cool naturally over time.
                    </div>
                    <ul class="feature-list">
                        <li>✓ Four fixed volumes (50, 100, 200, 500 ml)</li>
                        <li>✓ Continuous cooling simulation</li>
                        <li>✓ Energy flow visualization</li>
                        <li>✓ Temperature tracking over time</li>
                        <li>✓ Mathematical KE relationship visible</li>
                    </ul>
                    <button class="select-button">Start Basic Version</button>
                </div>
                
                <div class="version-card" onclick="selectVersion(2)">
                    <h2>🔬 Version 2: Advanced Analysis</h2>
                    <div class="description">
                        For deeper investigation with custom experiments and kinetic energy analysis. 
                        Test specific hypotheses and understand the physics at the particle level.
                    </div>
                    <ul class="feature-list">
                        <li>✓ All Version 1 features</li>
                        <li>✓ Custom volume testing (25-1000 ml)</li>
                        <li>✓ Discrete energy removal mode</li>
                        <li>✓ Average kinetic energy displays</li>
                        <li>✓ Temperature OR kinetic energy graphing</li>
                    </ul>
                    <button class="select-button">Start Advanced Version</button>
                </div>
            </div>
        </div>
        
        <!-- Simulation Screen -->
        <div id="simulationScreen" class="simulation-screen">
            <button class="back-button" onclick="goBack()">← Back to Version Selection</button>
            
            <h1 id="simTitle">🌡️ Volume vs Temperature Change</h1>
            <p class="subtitle" id="simSubtitle">Watch how different volumes of hot water cool down at different rates</p>
            
            <div class="info-panel" id="infoPanel">
                <h3>🔬 How to Use This Simulation</h3>
                <p id="infoPanelText">Observe four containers with different volumes of hot water and watch how they cool at different rates</p>
            </div>
            
            <div class="controls" id="controlsContainer">
                <div class="control-section version2-only">
                    <div class="section-title">🔬 Experiment Mode</div>
                    <div class="control-group">
                        <label for="coolingMode">Cooling Mode:</label>
                        <select id="coolingMode">
                            <option value="continuous">Continuous Cooling</option>
                            <option value="discrete">Discrete Energy Removal</option>
                        </select>
                    </div>
                    
                    <div class="control-group" id="discreteControls" style="display: none;">
                        <label>Remove Same Energy from All:</label>
                        <button id="removeEnergy" class="discrete-button">⚡ REMOVE ENERGY</button>
                    </div>
                    
                    <div class="control-group" id="continuousControls">
                        <label for="coolingRate">Cooling Rate:</label>
                        <select id="coolingRate">
                            <option value="slow">Slow</option>
                            <option value="normal" selected>Normal</option>
                            <option value="fast">Fast</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-title">⏯️ Simulation Controls</div>
                    <div class="control-group">
                        <label>Animation:</label>
                        <button id="startStop">▶️ START COOLING</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Speed:</label>
                        <button id="speedToggle">🏃 NORMAL SPEED</button>
                    </div>
                    
                    <div class="control-group">
                        <label for="initialTemp">Water Temperature:</label>
                        <select id="initialTemp">
                            <option value="180">180°F (Hot - Cools Down)</option>
                            <option value="40">40°F (Cold - Warms Up)</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-title">🔄 Reset Options</div>
                    <div class="control-group">
                        <label>Reset Simulation:</label>
                        <button id="reset" class="reset-button">🔄 RESET TO START</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Clear Graph:</label>
                        <button id="clearGraph">📊 CLEAR GRAPH</button>
                    </div>
                    
                    <div class="control-group version2-only">
                        <label>Apply Volume Changes:</label>
                        <button id="applyVolumes">📏 UPDATE VOLUMES</button>
                    </div>
                </div>
                
                <div class="control-section version2-only">
                    <div class="section-title">📊 Graph Display</div>
                    <div class="control-group">
                        <label for="graphMode">Graph Mode:</label>
                        <select id="graphMode">
                            <option value="temperature">Temperature (°C)</option>
                            <option value="kinetic">Average Kinetic Energy</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Graph Controls:</label>
                        <button id="toggleGraph">🔄 SWITCH TO KE</button>
                    </div>
                </div>
            </div>
            
            <div class="control-section version2-only" style="margin-bottom: 20px;">
                <div class="section-title">📏 Custom Volumes (25-1000 ml)</div>
                <div class="volume-inputs">
                    <div class="volume-input-group">
                        <label>Container 1:</label>
                        <input type="number" id="volume1" value="50" min="25" max="1000">
                    </div>
                    <div class="volume-input-group">
                        <label>Container 2:</label>
                        <input type="number" id="volume2" value="100" min="25" max="1000">
                    </div>
                    <div class="volume-input-group">
                        <label>Container 3:</label>
                        <input type="number" id="volume3" value="200" min="25" max="1000">
                    </div>
                    <div class="volume-input-group">
                        <label>Container 4:</label>
                        <input type="number" id="volume4" value="500" min="25" max="1000">
                    </div>
                </div>
            </div>
            
            <div class="legend">
                <h3>Atom Speed & Kinetic Energy Color Scale</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="color-box" style="background: #ff0000;"></div>
                        <span>Very High KE (Fast)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background: #ff8800;"></div>
                        <span>High KE (Medium-Fast)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background: #ffff00;"></div>
                        <span>Medium KE (Medium)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background: #00ff00;"></div>
                        <span>Low KE (Slow)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background: #0088ff;"></div>
                        <span>Very Low KE (Very Slow)</span>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="simulation-container">
                    <canvas id="particleCanvas" width="800" height="400"></canvas>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-label" id="label1">50 ml Cup</div>
                            <div class="stat-value" id="temp1">180°F</div>
                            <div class="energy-value" id="energy1">4500 KE units</div>
                            <div class="ke-value version2-only" id="ke1">0.80</div>
                            <div class="volume-label" id="atoms1">25 atoms</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="label2">100 ml Cup</div>
                            <div class="stat-value" id="temp2">180°F</div>
                            <div class="energy-value" id="energy2">9000 KE units</div>
                            <div class="ke-value version2-only" id="ke2">0.80</div>
                            <div class="volume-label" id="atoms2">50 atoms</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="label3">200 ml Cup</div>
                            <div class="stat-value" id="temp3">180°F</div>
                            <div class="energy-value" id="energy3">18000 KE units</div>
                            <div class="ke-value version2-only" id="ke3">0.80</div>
                            <div class="volume-label" id="atoms3">100 atoms</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="label4">500 ml Cup</div>
                            <div class="stat-value" id="temp4">180°F</div>
                            <div class="energy-value" id="energy4">45000 KE units</div>
                            <div class="ke-value version2-only" id="ke4">0.80</div>
                            <div class="volume-label" id="atoms4">250 atoms</div>
                        </div>
                        <div class="timer-box">
                            <div class="stat-label">Simulation Time</div>
                            <div class="stat-value" id="timer">0.0s</div>
                            <div class="volume-label">elapsed</div>
                        </div>
                    </div>
                </div>
                
                <div class="graph-container">
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #444; text-align: center;" id="graphTitle">Temperature Changes Over Time</h3>
                    </div>
                    <canvas id="graphCanvas" width="800" height="350"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentVersion = 1;
        let sim = null;
        
        function selectVersion(version) {
            currentVersion = version;
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('simulationScreen').style.display = 'block';
            
            const container = document.getElementById('simulationScreen');
            if (version === 2) {
                container.classList.add('version2');
                document.getElementById('controlsContainer').classList.add('version2');
                document.getElementById('infoPanelText').innerHTML = 
                    '<strong>1.</strong> Set custom volumes or use defaults<br>' +
                    '<strong>2.</strong> Choose between continuous cooling or discrete energy removal<br>' +
                    '<strong>3.</strong> Choose hot water (cools down) or cool water (warms up)<br>' +
                    '<strong>4.</strong> Notice the math: Total KE Units ÷ Atoms = Temperature';
            } else {
                container.classList.remove('version2');
                document.getElementById('controlsContainer').classList.remove('version2');
                document.getElementById('infoPanelText').innerHTML = 
                    '<strong>1.</strong> Watch four containers with different volumes<br>' +
                    '<strong>2.</strong> Choose hot water (cools down) or cool water (warms up)<br>' +
                    '<strong>3.</strong> Observe energy flow arrows showing heat transfer<br>' +
                    '<strong>4.</strong> Notice the math: Total KE Units ÷ Atoms = Temperature';
            }
            
            sim = new VolumeSimulation();
        }
        
        function goBack() {
            document.getElementById('introScreen').style.display = 'block';
            document.getElementById('simulationScreen').style.display = 'none';
            if (sim) {
                sim.running = false;
                sim = null;
            }
        }
        
        class Atom {
            constructor(x, y, container, initialTemp = 80) {
                this.x = x;
                this.y = y;
                this.container = container;
                this.temperature = initialTemp;
                this.kineticEnergy = initialTemp;
                this.radius = 3;
                
                this.setVelocityFromKE();
            }
            
            setVelocityFromKE() {
                const maxSpeed = (this.temperature / 100) * 3;
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * maxSpeed;
                this.vy = Math.sin(angle) * maxSpeed;
            }
            
            update(speedMult, coolingRate, coolingMode, sim) {
                if (coolingMode === 'continuous') {
                    const volume = sim.containers[this.container].volume;
                    const surfaceAreaRatio = 1 / Math.pow(volume, 0.33);
                    const roomTemp = 70; // Room temperature is 70°F
                    
                    // Calculate temperature difference between water and room
                    const tempDifference = this.temperature - roomTemp;
                    
                    // Energy flows toward equilibrium (room temperature)
                    let energyChangeRate = 0.02 * surfaceAreaRatio * coolingRate;
                    
                    if (tempDifference > 0) {
                        // Water is hotter than room - loses energy (cools down)
                        this.kineticEnergy = Math.max(roomTemp, this.kineticEnergy - energyChangeRate);
                    } else if (tempDifference < 0) {
                        // Water is cooler than room - gains energy (warms up)
                        this.kineticEnergy = Math.min(roomTemp, this.kineticEnergy + energyChangeRate);
                    }
                    
                    this.temperature = this.kineticEnergy;
                    this.setVelocityFromKE();
                }
                
                this.x += this.vx * speedMult;
                this.y += this.vy * speedMult;
                
                const bounds = this.getContainerBounds(sim);
                
                if (this.x - this.radius <= bounds.left || this.x + this.radius >= bounds.right) {
                    this.vx *= -0.9;
                    this.x = Math.max(bounds.left + this.radius, Math.min(bounds.right - this.radius, this.x));
                }
                if (this.y - this.radius <= bounds.top || this.y + this.radius >= bounds.bottom) {
                    this.vy *= -0.9;
                    this.y = Math.max(bounds.top + this.radius, Math.min(bounds.bottom - this.radius, this.y));
                }
            }
            
            removeEnergy(amount) {
                this.kineticEnergy = Math.max(0, this.kineticEnergy - amount);
                this.temperature = this.kineticEnergy;
                this.setVelocityFromKE();
            }
            
            getContainerBounds(sim) {
                const containerWidth = 180;
                const containerHeight = 280;
                const startX = this.container * 200 + 10;
                const startY = 100;
                
                const maxVolume = 500;
                const volume = sim ? sim.containers[this.container].volume : [50, 100, 200, 500][this.container];
                const waterHeightRatio = Math.min(1, volume / maxVolume);
                const waterHeight = containerHeight * waterHeightRatio;
                const waterTop = startY + containerHeight - waterHeight;
                
                return {
                    left: startX + 5,
                    right: startX + containerWidth - 5,
                    top: waterTop + 5,
                    bottom: startY + containerHeight - 5
                };
            }
            
            getColor() {
                const temp = this.temperature;
                if (temp > 140) return '#ff0000';      // Very hot red (140°F+)
                if (temp > 100) return '#ff8800';      // Hot orange (100-140°F)
                if (temp > 70) return '#ffff00';       // Warm yellow (70-100°F) - room temp and above
                if (temp > 50) return '#00ff00';       // Cool green (50-70°F)
                return '#0088ff';                      // Cold blue (below 50°F)
            }
        }
        
        class VolumeSimulation {
            constructor() {
                this.canvas = document.getElementById('particleCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.graphCanvas = document.getElementById('graphCanvas');
                this.graphCtx = this.graphCanvas.getContext('2d');
                
                this.containers = [
                    { volume: 50, atoms: [], atomCount: 25, name: "50 ml" },
                    { volume: 100, atoms: [], atomCount: 50, name: "100 ml" },
                    { volume: 200, atoms: [], atomCount: 100, name: "200 ml" },
                    { volume: 500, atoms: [], atomCount: 250, name: "500 ml" }
                ];
                
                this.running = false;
                this.speedMode = 'normal';
                this.time = 0;
                this.graphData = [];
                this.colors = ['#ff4444', '#4444ff', '#44ff44', '#ff44ff'];
                this.energyFlows = [0, 0, 0, 0];
                this.graphMode = 'temperature';
                
                if (currentVersion === 2) {
                    this.updateContainerVolumes();
                }
                this.initAtoms();
                this.setupEventListeners();
                this.updateStats();
                this.draw();
                this.drawGraph();
            }
            
            updateContainerVolumes() {
                if (currentVersion !== 2) return;
                
                const volumes = [
                    parseInt(document.getElementById('volume1').value),
                    parseInt(document.getElementById('volume2').value),
                    parseInt(document.getElementById('volume3').value),
                    parseInt(document.getElementById('volume4').value)
                ];
                
                volumes.forEach((volume, index) => {
                    this.containers[index].volume = Math.max(25, Math.min(1000, volume));
                    this.containers[index].atomCount = Math.max(10, Math.round(volume / 2));
                    this.containers[index].name = `${volume} ml`;
                    
                    document.getElementById(`label${index + 1}`).textContent = `${volume} ml Cup`;
                    document.getElementById(`atoms${index + 1}`).textContent = `${this.containers[index].atomCount} atoms`;
                });
            }
            
            initAtoms() {
                const initialTemp = parseInt(document.getElementById('initialTemp').value);
                
                this.containers.forEach((container, containerIndex) => {
                    container.atoms = [];
                    const containerWidth = 180;
                    const containerHeight = 280;
                    const startX = containerIndex * 200 + 20;
                    const startY = 110;
                    
                    const maxVolume = 500;
                    const waterHeightRatio = Math.min(1, container.volume / maxVolume);
                    const waterHeight = containerHeight * waterHeightRatio;
                    const waterTop = startY + containerHeight - waterHeight;
                    
                    for (let i = 0; i < container.atomCount; i++) {
                        const x = startX + Math.random() * (containerWidth - 20);
                        const y = waterTop + 10 + Math.random() * (waterHeight - 20);
                        container.atoms.push(new Atom(x, y, containerIndex, initialTemp));
                    }
                });
                
                this.time = 0;
                this.graphData = [];
                this.energyFlows = [0, 0, 0, 0];
            }
            
            setupEventListeners() {
                if (currentVersion === 2) {
                    document.getElementById('coolingMode').addEventListener('change', () => {
                        const mode = document.getElementById('coolingMode').value;
                        if (mode === 'discrete') {
                            document.getElementById('discreteControls').style.display = 'block';
                            document.getElementById('continuousControls').style.display = 'none';
                            if (this.running) {
                                this.running = false;
                                document.getElementById('startStop').textContent = '▶️ START ANIMATION';
                            }
                        } else {
                            document.getElementById('discreteControls').style.display = 'none';
                            document.getElementById('continuousControls').style.display = 'block';
                        }
                    });
                    
                    document.getElementById('removeEnergy').addEventListener('click', () => {
                        const energyAmount = 20;
                        
                        this.containers.forEach(container => {
                            container.atoms.forEach(atom => {
                                atom.removeEnergy(energyAmount);
                            });
                        });
                        
                        this.updateStats();
                        this.recordTemperatures();
                        this.draw();
                        this.drawGraph();
                    });
                    
                    document.getElementById('applyVolumes').addEventListener('click', () => {
                        this.updateContainerVolumes();
                        this.initAtoms();
                        this.updateStats();
                        this.draw();
                        this.drawGraph();
                    });
                    
                    document.getElementById('graphMode').addEventListener('change', () => {
                        this.graphMode = document.getElementById('graphMode').value;
                        this.updateGraphTitle();
                        this.drawGraph();
                    });
                    
                    document.getElementById('toggleGraph').addEventListener('click', () => {
                        if (this.graphMode === 'temperature') {
                            this.graphMode = 'kinetic';
                            document.getElementById('graphMode').value = 'kinetic';
                            document.getElementById('toggleGraph').textContent = '🔄 SWITCH TO TEMP';
                        } else {
                            this.graphMode = 'temperature';
                            document.getElementById('graphMode').value = 'temperature';
                            document.getElementById('toggleGraph').textContent = '🔄 SWITCH TO KE';
                        }
                        this.updateGraphTitle();
                        this.drawGraph();
                    });
                }
                
                document.getElementById('startStop').addEventListener('click', () => {
                    this.running = !this.running;
                    document.getElementById('startStop').textContent = 
                        this.running ? '⏸️ PAUSE' : '▶️ START ANIMATION';
                    if (this.running) this.animate();
                });
                
                document.getElementById('speedToggle').addEventListener('click', () => {
                    if (this.speedMode === 'normal') {
                        this.speedMode = 'slow';
                        document.getElementById('speedToggle').textContent = '🐢 SLOW MOTION';
                    } else if (this.speedMode === 'slow') {
                        this.speedMode = 'fast';
                        document.getElementById('speedToggle').textContent = '⚡ FAST SPEED';
                    } else {
                        this.speedMode = 'normal';
                        document.getElementById('speedToggle').textContent = '🏃 NORMAL SPEED';
                    }
                });
                
                document.getElementById('reset').addEventListener('click', () => {
                    this.running = false;
                    document.getElementById('startStop').textContent = '▶️ START ANIMATION';
                    this.speedMode = 'normal';
                    document.getElementById('speedToggle').textContent = '🏃 NORMAL SPEED';
                    this.initAtoms();
                    this.updateStats();
                    this.draw();
                    this.drawGraph();
                });
                
                document.getElementById('clearGraph').addEventListener('click', () => {
                    this.graphData = [];
                    this.time = 0;
                    this.drawGraph();
                });
                
                document.getElementById('initialTemp').addEventListener('change', () => {
                    if (!this.running) {
                        this.initAtoms();
                        this.updateStats();
                        this.draw();
                        this.drawGraph();
                    }
                });
            }
            
            updateGraphTitle() {
                if (currentVersion === 2) {
                    const title = this.graphMode === 'temperature' ? 
                        'Temperature Changes Over Time' : 
                        'Average Kinetic Energy Over Time';
                    document.getElementById('graphTitle').textContent = title;
                }
            }
            
            animate() {
                if (!this.running) return;
                
                let speedMult;
                switch(this.speedMode) {
                    case 'slow': speedMult = 0.3; break;
                    case 'fast': speedMult = 2.0; break;
                    default: speedMult = 1.0;
                }
                
                const coolingRateSelect = document.getElementById('coolingRate');
                let coolingRate = 1.0;
                if (coolingRateSelect) {
                    switch(coolingRateSelect.value) {
                        case 'slow': coolingRate = 0.5; break;
                        case 'fast': coolingRate = 2.0; break;
                        default: coolingRate = 1.0;
                    }
                }
                
                const coolingModeSelect = document.getElementById('coolingMode');
                const coolingMode = coolingModeSelect ? coolingModeSelect.value : 'continuous';
                
                if (coolingMode === 'continuous') {
                    this.energyFlows = this.containers.map(container => {
                        const volume = container.volume;
                        const surfaceAreaRatio = 1 / Math.pow(volume, 0.33);
                        return surfaceAreaRatio * coolingRate;
                    });
                }
                
                this.containers.forEach(container => {
                    container.atoms.forEach(atom => {
                        atom.update(speedMult, coolingRate, coolingMode, this);
                    });
                });
                
                this.draw();
                
                if (this.time % 30 === 0) {
                    this.updateStats();
                    if (coolingMode === 'continuous') {
                        this.recordTemperatures();
                        this.drawGraph();
                    }
                }
                
                this.time++;
                requestAnimationFrame(() => this.animate());
            }
            
            drawEnergyFlowArrows() {
                const coolingModeSelect = document.getElementById('coolingMode');
                const coolingMode = coolingModeSelect ? coolingModeSelect.value : 'continuous';
                if (coolingMode !== 'continuous' || !this.running) return;
                
                this.ctx.save(); // Save state before drawing arrows
                
                this.containers.forEach((container, index) => {
                    const x = index * 200 + 100;
                    const y = 80;
                    
                    const flowRate = this.energyFlows[index];
                    // Limit arrow dimensions to reasonable values
                    const arrowThickness = Math.max(1, Math.min(5, Math.abs(flowRate) * 10000));
                    const arrowLength = Math.max(20, Math.min(50, 30 + Math.abs(flowRate) * 50000));
                    
                    // Calculate average temperature to determine flow direction
                    const avgTemp = container.atoms.length > 0 ? 
                        container.atoms.reduce((sum, atom) => sum + atom.temperature, 0) / container.atoms.length : 70;
                    const roomTemp = 70; // Room temperature is 70°F
                    
                    this.ctx.globalAlpha = 0.7;
                    this.ctx.lineWidth = arrowThickness;
                    
                    if (avgTemp > roomTemp) {
                        // Energy flowing OUT (cooling) - arrow pointing up
                        this.ctx.strokeStyle = '#ff6b6b';
                        this.ctx.fillStyle = '#ff6b6b';
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y);
                        this.ctx.lineTo(x, y - arrowLength);
                        this.ctx.stroke();
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y - arrowLength);
                        this.ctx.lineTo(x - 8, y - arrowLength + 15);
                        this.ctx.lineTo(x + 8, y - arrowLength + 15);
                        this.ctx.closePath();
                        this.ctx.fill();
                    } else if (avgTemp < roomTemp) {
                        // Energy flowing IN (warming) - arrow pointing down
                        this.ctx.strokeStyle = '#4a90e2';
                        this.ctx.fillStyle = '#4a90e2';
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y - 40);
                        this.ctx.lineTo(x, y - 40 + arrowLength);
                        this.ctx.stroke();
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y - 40 + arrowLength);
                        this.ctx.lineTo(x - 8, y - 40 + arrowLength - 15);
                        this.ctx.lineTo(x + 8, y - 40 + arrowLength - 15);
                        this.ctx.closePath();
                        this.ctx.fill();
                    }
                });
                
                this.ctx.restore(); // Restore state after drawing arrows
            }
            
            draw() {
                // Clear canvas and explicitly reset all properties
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Explicit full canvas property reset
                this.ctx.globalAlpha = 1.0;
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.fillStyle = '#ffffff';
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 1;
                this.ctx.lineCap = 'butt';
                this.ctx.lineJoin = 'miter';
                this.ctx.font = '10px sans-serif';
                this.ctx.textAlign = 'start';
                this.ctx.textBaseline = 'alphabetic';
                
                // Fill entire canvas with white to ensure clean background
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.save(); // Save the clean state
                
                this.containers.forEach((container, index) => {
                    this.ctx.save(); // Save state before each container
                    
                    const x = index * 200 + 10;
                    const y = 100;
                    const width = 180;
                    const height = 280;
                    
                    const maxVolume = 500;
                    const waterHeightRatio = Math.min(1, container.volume / maxVolume);
                    const waterHeight = height * waterHeightRatio;
                    const waterTop = y + height - waterHeight;
                    
                    // Draw container outline
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeRect(x, y, width, height);
                    
                    // Draw water background - always light blue regardless of temperature
                    this.ctx.fillStyle = '#e6f3ff';
                    this.ctx.fillRect(x + 2, waterTop, width - 4, waterHeight - 2);
                    
                    // Draw water level line
                    this.ctx.strokeStyle = '#4a90e2';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x + 5, waterTop);
                    this.ctx.lineTo(x + width - 5, waterTop);
                    this.ctx.stroke();
                    
                    // Draw labels
                    this.ctx.fillStyle = '#333';
                    this.ctx.font = 'bold 16px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(container.name, x + width/2, y - 10);
                    
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(`${container.atomCount} atoms`, x + width/2, y + height + 20);
                    
                    this.ctx.restore(); // Restore state after each container
                });
                
                // Draw energy flow arrows
                this.drawEnergyFlowArrows();
                
                // Draw atoms on top of everything else
                this.containers.forEach(container => {
                    container.atoms.forEach(atom => {
                        this.ctx.save(); // Save state before each atom
                        this.ctx.fillStyle = atom.getColor();
                        this.ctx.beginPath();
                        this.ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.restore(); // Restore state after each atom
                    });
                });
                
                this.ctx.restore(); // Restore to the original clean state
            }
            
            updateStats() {
                this.containers.forEach((container, index) => {
                    if (container.atoms.length > 0) {
                        const totalKE = container.atoms.reduce((sum, atom) => sum + atom.kineticEnergy, 0);
                        const avgTemp = totalKE / container.atoms.length;
                        const avgKEForDisplay = avgTemp / 100;
                        
                        const tempElement = document.getElementById(`temp${index + 1}`);
                        const energyElement = document.getElementById(`energy${index + 1}`);
                        const keElement = document.getElementById(`ke${index + 1}`);
                        
                        if (tempElement) {
                            tempElement.textContent = `${avgTemp.toFixed(1)}°C`;
                        }
                        if (energyElement) {
                            energyElement.textContent = `${Math.round(totalKE)} KE units`;
                        }
                        if (keElement && currentVersion === 2) {
                            keElement.textContent = `${avgKEForDisplay.toFixed(3)}`;
                        }
                    }
                });
                
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    const seconds = this.time / 30;
                    timerElement.textContent = `${seconds.toFixed(1)}s`;
                }
            }
            
            recordTemperatures() {
                const data = this.containers.map(container => {
                    if (container.atoms.length === 0) return { temp: 80, ke: 0.8 };
                    const totalKE = container.atoms.reduce((sum, atom) => sum + atom.kineticEnergy, 0);
                    const avgTemp = totalKE / container.atoms.length;
                    const avgKE = avgTemp / 100;
                    return { temp: avgTemp, ke: avgKE };
                });
                
                this.graphData.push(data);
                if (this.graphData.length > 600) {
                    this.graphData.shift();
                }
            }
            
            drawGraph() {
                const ctx = this.graphCtx;
                const width = this.graphCanvas.width;
                const height = this.graphCanvas.height;
                
                ctx.clearRect(0, 0, width, height);
                
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 10; i++) {
                    ctx.beginPath();
                    ctx.moveTo(50, height * i / 10);
                    ctx.lineTo(width - 20, height * i / 10);
                    ctx.stroke();
                }
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(50, 20);
                ctx.lineTo(50, height - 40);
                ctx.lineTo(width - 20, height - 40);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                
                if (this.graphMode === 'kinetic' && currentVersion === 2) {
                    ctx.fillText('1.0', 20, 25);
                    ctx.fillText('0.5', 20, height/2);
                    ctx.fillText('0.0', 20, height - 45);
                } else {
                    ctx.fillText('200°F', 10, 25);
                    ctx.fillText('110°F', 15, height/2);
                    ctx.fillText('20°F', 15, height - 45);
                }
                
                ctx.fillText('0s', 50, height - 15);
                ctx.fillText('300s', width/2 - 10, height - 15);
                ctx.fillText('600s', width - 50, height - 15);
                ctx.fillText('Time', width/2 - 15, height - 10);
                
                if (this.graphMode === 'kinetic' && currentVersion === 2) {
                    ctx.fillText('Kinetic Energy', 10, 15);
                } else {
                    ctx.fillText('Temperature', 10, 15);
                }
                
                if (this.graphData.length > 1) {
                    this.containers.forEach((container, containerIndex) => {
                        ctx.strokeStyle = this.colors[containerIndex];
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        
                        for (let i = 0; i < this.graphData.length; i++) {
                            const timeInSeconds = i;
                            const x = 50 + (timeInSeconds / 600) * (width - 70);
                            
                            let value;
                            if (this.graphMode === 'kinetic' && currentVersion === 2) {
                                value = this.graphData[i][containerIndex].ke;
                                const normalizedValue = Math.max(0, Math.min(1, value));
                                const y = height - 50 - (normalizedValue * (height - 70));
                                if (i === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            } else {
                                value = this.graphData[i][containerIndex].temp || this.graphData[i][containerIndex];
                                const tempRange = 200 - 20; // 180°F range (20°F to 200°F)
                                const normalizedTemp = Math.max(0, Math.min(1, (value - 20) / tempRange));
                                const y = height - 50 - (normalizedTemp * (height - 70));
                                if (i === 0) ctx.moveTo(x, y);
                                else ctx.lineTo(x, y);
                            }
                        }
                        ctx.stroke();
                    });
                }
                
                this.containers.forEach((container, index) => {
                    const legendY = 30 + index * 25;
                    ctx.fillStyle = this.colors[index];
                    ctx.fillRect(width - 150, legendY, 20, 3);
                    ctx.fillStyle = '#333';
                    ctx.font = '11px Arial';
                    ctx.fillText(`${container.name} (${container.atomCount} atoms)`, width - 125, legendY + 5);
                });
            }
        }
    </script>
</body>
</html>
